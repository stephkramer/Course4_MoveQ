---
title: "Tutorial Part IV - Movement - Solution Exercise 1"
author: "Stephanie Kramer-Schadt & CÃ©dric Scherer"
date: "`r Sys.setlocale('LC_TIME','C'); paste('Last Update', format(Sys.time(), '%B %e, %Y'))`"
output:
  rmdformats::readthedown:
    highlight: kate
    toc_depth: 2
    toc_float: true
editor_options:
  chunk_output_type: console
params:
  date: !r Sys.Date()
---

<style>
h1 {
  color: Orange ;
}
h2, h3, h4, h5, h6, legend {
  color: Indigo ;
}
p {
  line-height:170%;
}
#sidebar h2 {
  background-color: Indigo;
}
code {
  color: Indigo ;
}
.exercise {
  color: #824b00;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      fig.width = 9, fig.height = 6, dev = "ragg_png")
#knitr::opts_knit$set(root.dir = 'C:/Users/kramer/PopDynIZW Dropbox/Steph Kramer')
#or on GUI: knit -> knit directory -> project directory
```


#  Exercise 4

## Exercise 4.1

This is recap from Course2. Please plot the animal relocations in two different 
colours based on the column `daytime`, using the *data.frame* and one of 
the options to create maps with `{ggplot2}`, `{ggpmap}`, `{leaflet}` or `{tmap}`.
Use the processed file of fox Q (*tag5334_gps_proc*) and do it in a separate script. 
Save your script as `Course4_Exercise1_*yourname*.R`.
<br><br>
Hint: Remember to load the relevant libraries.
Note that you might want to plot the locations in the correct
spatial dimensions by projecting it using the functions
`st_as_sf()` and `st_transform()`.  

***

a. Load the processed data file

```{r libs, echo=TRUE}
library(here)
library(sf)
```


```{r, echo=-2}
animal <- readRDS(file = here("output", "data-proc", "tag5334_gps_proc.Rds")) 
# animal <- readRDS(file = 'C:/Users/kramer/PopDynIZW Dropbox/Steph #Kramer/_GitHub/Course4_MoveQ/output/data-proc/tag5334_gps_proc.Rds')

## transform into spatial simple feature sf object
mydf_sf <- st_as_sf(x = animal, ## data.frame(animal) -> bei mir geht's auch ohne data.frame()
                    coords = c("longitude", "latitude"),
                    crs = 4326,
                    sf_column_name = "geometry" )
## and project
mydf_sf_trans <- st_transform(mydf_sf, 5631)  ## EPSG-code Pulkovo
```
<br>

b. Plot the data

***Base R***

A quick plot from the simple *data.frame*

```{r}
## latitude is y-Axis, longitude = x-axis in cartesian coordinate system
plot(animal$latitude ~ animal$longitude,
     pch = ".",
     col = as.numeric(animal$daytime) + 1) ## + 1 because color 0 is transparent
```
<br>

A quick plot of the movement path, using only the first 50 observations:

```{r}
plot(animal$latitude[1:50] ~ animal$longitude[1:50], type= 'l') 
```
<br>

The problem: all of the observations are not projected but use the Cartesian coordinates (i.e. in a default, rectangular 2-D projection).
<br>

---

***`{ggplot2}`***

The first approach might be to plot the x and y coordinates with using `geom_point()`:

```{r}
library(ggplot2)

baseplot_df <- 
  ggplot(data = animal, 
         aes(x = longitude,
             y = latitude,
             color = daytime)) +
    geom_point(size = 0.01, alpha = 0.5) +  
    labs(x = "Longitude", y = "Latitude",
         title = "Telemetry data") +
    theme_bw(base_size = 16)

baseplot_df
```
<br>

Note that the `baseplot_df` uses x and y coordinates but not the projection (i.e. the distance between points changes when changing the aspect ratio of the plot) as it uses a Cartesian coordinate system as in the base plot. 

As we are dealing with spatial data, it is better to use the projected sf object with the dedicated `geom_sf()` layer for `{ggplot2}`:

```{r}
baseplot_sf <- 
  ggplot(data = mydf_sf_trans, 
         aes(color = daytime)) +
    geom_sf(size = 0.01, alpha = 0.5) +  
    labs(x = "Longitude", y = "Latitude",
         title = "Telemetry data") +
    theme_bw(base_size = 16)

baseplot_sf
```

Get more inspiration here:
https://github.com/Z3tt/TidyTuesday/blob/master/R/2020_26_CaribouLocations.Rmd
<br>

```{r, include = FALSE}
densplot <- 
  baseplot_sf + 
  stat_density_2d(
    aes(x = st_coordinates(mydf_sf_trans)[,1], 
        y = st_coordinates(mydf_sf_trans)[,2], 
        alpha = ..level..,
        color = daytime,
        color = after_scale(colorspace::darken(color, .5, space = "HLS")),  
        fill  = after_scale(colorspace::lighten(color, .4, space = "HLS"))),
    geom  = "polygon",
    size  = .02,
    n = 500,
    bins = 5,
    adjust = 3)  

densplot

# example of how to save the plot to your file
# ggsave(here("plots", "plot_pointdensity.png"), dpi = 800, height = 6, width = 6)
```

---

***`{ggmap}`***

We can also add a background using the `{ggmap}` package. Check the cheatsheet for a quick start to `{ggmap}`:
https://www.nceas.ucsb.edu/sites/default/files/2020-04/ggmapCheatsheet.pdf

```{r}
library(ggmap)

## define a bounding box for the plot
b <- c(13.460, 52.485, 13.490, 52.500) ## make large enough to plot all data!

my_tiles <- get_map(location = b, maptype = "terrain", source = "osm", zoom = 15)

ggmap(my_tiles) + 
  geom_point(aes(x = longitude, y = latitude), 
             data = data.frame(animal), 
             colour = as.numeric(animal$daytime) + 6, 
             size = 0.05) + 
  labs(x = "Latitude", y = "Longitude", title = "Telemetry locations")
```
<br>

---

***`{leaflet}`***

A nice interactive plot can be created with `{leaflet}`. The first location of the track is marked:

```{r}
library(leaflet)

# get first location of track
base_wgs84_x <- animal$longitude[1]
base_wgs84_y <- animal$latitude[1]

m_leaf <- leaflet(animal) %>% 
  addTiles() %>%
  addMarkers(lng = base_wgs84_x, lat = base_wgs84_y, 
             popup = "Start") %>%
  addPopups(base_wgs84_x, base_wgs84_y, "Starting point",
            options = popupOptions(closeButton = TRUE)) %>%
  addCircles(lng = ~longitude, lat = ~latitude, ~5,
             stroke = TRUE,
             color = "white",
             weight = 1,
             fill = TRUE, 
             fillColor = "blue",
             fillOpacity = 0.3) 

m_leaf
```
<br>

`{leaflet}` maps are great for interactive usage but bad for export -> create maps with `{ggplot2}` and `{ggmap}` or `{tmap}` instead!

---

***`{tmap}`***

Finally a static and an interactive map via `{tmap}`:

```{r}
library(tmap)

tmap_mode(mode = "plot")

tm_shape(shp = mydf_sf_trans) + 
  tm_dots(size = 0.01, 
          col = "daytime",  
          alpha = 0.5) 
```

```{r}
tmap_mode(mode = "view")

tm_shape(shp = mydf_sf_trans) + 
  tm_dots(size = 0.01, 
          col = "daytime",  
          alpha = 0.5) 
```

# END

---

<details><summary>Session Info</summary>

```{r sessionInfo}
Sys.time()
sessionInfo()
```

</details>
