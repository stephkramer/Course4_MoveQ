---
title: "Tutorial Part IV - Movement - Solution Exercise 2"
author: "Stephanie Kramer-Schadt & CÃ©dric Scherer"
date: "`r Sys.setlocale('LC_TIME','C'); paste('Last Update', format(Sys.time(), '%B %e, %Y'))`"
output:
  rmdformats::readthedown:
    highlight: kate
    toc_depth: 2
    toc_float: true
editor_options:
  chunk_output_type: console
params:
  date: !r Sys.Date()
---

<style>
h1 {
  color: Orange ;
}
h2, h3, h4, h5, h6, legend {
  color: Indigo ;
}
p {
  line-height:170%;
}
#sidebar h2 {
  background-color: Indigo;
}
code {
  color: Indigo ;
}
.exercise {
  color: #824b00;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      fig.width = 9, fig.height = 6, dev = "ragg_png")
#knitr::opts_knit$set(root.dir = 'C:/Users/kramer/PopDynIZW Dropbox/Steph Kramer')
#or on GUI: knit -> knit directory -> project directory
```

#  Course 4

## Exercise 4.2

**Animals have been collared and tracked, and we want to know their home range size and whether the animals actually avoid agriculture and prefer forest. <br>
There is telemetry data available from three animals (`DieTiere_32633.shp`) in the
folder data-raw. Additionally, land cover (`Landnutzung_3035.shp`) and rivers (`linearegew_32633.shp`) are available in the `geo-raw` folder. 
Land use has a column `NS1` with coded info on `1` (urban areas), `2` (agriculture), 
`3` (forest), `4` (swamps), and `5` (water bodies).<br>**

After loading the necessary libraries, the data and making a plot, please do the following:<br>

* a. Calculate their home ranges.<br>
* b. Buffer the home range with the mean steplength of all three animals.<br>
* c. Clip the home ranges with the underlying landscape and calculate the percentage of land use classes 2 (agriculture) and 2 (forest) within the home range (hint: use `st_intersection()`  AND
recalculate the column for AREA in km2).<br>
* d. In which land use are the animals actually located? Extract land use underneath each telemetry location (hint: `st_join()`). Do the animals actually avoid agriculture?
<br><br>


### Get started

```{r}
## Open libraries
## general basics
library(here)
library(ggplot2)

## the basic packages for spatial analyses and viz
library(sf)
library(terra)
library(tmap)

## for telemetry and home range analyses
library(move)
library(adehabitatHR) 
library(sp)
```

Define workspace and folder structure:

```{r}
work_wd <- here()
data_raw_wd <- here("data-raw")
geo_raw_wd  <- here("data-raw", "geo-raw")
output_wd   <- here("output")
```

Load data sets:

```{r}
# if you are not sure about the file names, check the folder content with
# list.files(data_raw_wd)
animals <- st_read(layer = "DieTiere_32633", dsn = data_raw_wd)  
landcov <- st_read(layer = "Landnutzung_3035", dsn = geo_raw_wd)    
rivers  <- st_read(layer = "linearegew_32633", dsn = geo_raw_wd)   
```

Define or transform coordinate reference system (CRS):

```{r}
lc_32633 <- st_transform(landcov, 32633)
```

Make a plot of the data:

**ggplot2:**

```{r}
## Create a color code for the 5 land use classes
land_cols <- c("red", "antiquewhite", "chartreuse4", "cornsilk4", "navyblue")

## Create a color code for the 3 individuals
id_cols <- viridis::inferno(n = 12)[c(2,4,6)]

ggplot() +
  geom_sf(data = lc_32633, aes(fill = as.factor(NS1)), color = NA, alpha = .4) +
  geom_sf(data = rivers, color = "navyblue", alpha = .4) +
  geom_sf(data = animals, aes(color = as.factor(ID))) +
  scale_color_manual(values = id_cols, name = "Animal ID") +
  scale_fill_manual(values = land_cols, name = "Land Use Class") +
  theme_minimal(base_size = 15)
```

**tmap:**

```{r}
## Create a color code for the 5 land use classes
land_cols <- c("red", "antiquewhite", "chartreuse4", "cornsilk4", "navyblue")

## Create a color code for the 3 individuals
id_cols <- viridis::inferno(n = 12)[c(2,4,6)]

tmap_mode(mode = "view")

tm_shape(shp = lc_32633[,'NS1']) + 
    tm_polygons(col = "NS1", palette = land_cols, alpha = .4) +
  tm_shape(shp = rivers[,1]) + 
    tm_lines(col = 'blue')  +
  tm_shape(shp = animals[,'ID']) + 
    tm_dots(col = "ID", palette = id_cols)
```
<br>

* **a.** Calculate their home ranges.<br><br>
and<br><br>
* **b.** Buffer the home range with the mean displacement per step of all three animals.<br>

First , we retrieve the step length. For this, transform the `sf` object into a `move` object:

```{r}
anim_coords <- as.data.frame(st_coordinates(animals)) ## returns a list
animals$X <- anim_coords$X
animals$Y <- anim_coords$Y
animals_ng <- st_drop_geometry(animals)

animals_move <- move(x = animals_ng$X, y = animals_ng$Y,
                     time = as.POSIXct(animals_ng$MYDATUM, 
                                       format = "%Y-%m-%d 8:0:0", tz = "CET"), 
                     proj = CRS("+init=epsg:32633"),
                     data = animals_ng, animal = animals_ng$ID, sensor = "GPS")
```

Check the data by plotting the new `move` object:

```{r}
plot(animals_move, type = "l")
```

Since we have 3 animals, a list with 3 elements is returned:

```{r}
steplength_per_animal <- distance(animals_move)
mean_stepl_p_anim <- lapply(steplength_per_animal,mean)
(mean(unlist(mean_stepl_p_anim)))
```

> The mean step length is approx. `r round(mean(unlist(mean_stepl_p_anim)), -1)` m. 

Now use this value to buffer the MCPs:

```{r}
## for using mcp() in {adehabitatHR}, convert to SpatialPointsDataframe of {sp}
animals_sp <- as(animals, "Spatial")

## calculate MCP
mcp <- mcp(animals_sp[,"ID"], percent = 95) 

## the buffer command needs however an sf object
mcp_sf  <- as(mcp, "sf")
mcp_buf <- st_buffer(mcp_sf, 300)

## the plot is correct
plot(mcp)                         
plot(animals_sp, add = TRUE, col = animals_sp$ID) 
plot(mcp_buf[,1], add = TRUE)
plot(animals_sp, add = TRUE, col = id_cols) 
plot(mcp, add = TRUE)

## save buffer to disc
st_write(obj = mcp_buf, 
         dsn = output_wd, 
         layer = "mcp_buffer_32633",
         driver = "ESRI Shapefile", 
         delete_layer = TRUE)
```
<br>

* **c.** Clip the home ranges with the underlying landscape and calculate the percentage of land use classes 2 (agriculture) and 2 (forest) within the home range (hint: use `st_intersection()`).<br>

```{r}
## check the total area of the buffer in km2 per animal:
buf_area <- st_area(mcp_buf) / 1e6

## clip with land use
mcp_buf_lc <- st_intersection(lc_32633, mcp_buf) 

## have a look at the object:
mcp_buf_lc

## take care, you have to recalculate the area!
mcp_buf_lc$areakm2 <- st_area(mcp_buf_lc) / 1e6

## now, for each animal id, summarize the area per NS1-category 2 and 3:
agri   <- tapply(mcp_buf_lc$areakm2[mcp_buf_lc$NS1 == 2], 
                 mcp_buf_lc$id[mcp_buf_lc$NS1 == 2], 
                 FUN = sum)

forest <- tapply(mcp_buf_lc$areakm2[mcp_buf_lc$NS1 == 3],
                 mcp_buf_lc$id[mcp_buf_lc$NS1 == 3], 
                 FUN = sum)

## percentages
round(agri / buf_area * 100, 0)
round(forest / buf_area * 100, 0)
```
<br>

* **d.** In which land use are the animals actually located? Extract land use underneath each telemetry location (hint: `st_join()`). Do the animals actually avoid agriculture?<br>

```{r}
spatjoin <- st_join(animals, lc_32633)
myres <- table(spatjoin$NS1, spatjoin$ID)
myres

## now divide that by the total number of locations per animal
myn <- table(animals$ID)

round((myres[1,] / myn*100), 0)  ## agriculture
round((myres[2,] / myn*100), 0)  ## forest
```

Compare the values with the percentages above.  
  
For example, animal 1 had 71% of agriculture and 29% of forest in its HR, 
however, only 25% of the locations were actually in agriculture, but 75% of
its locations were in forest. We could conclude that animal 1 avoids agriculture.

<br><hr><br>

<details><summary>Session Info</summary>

```{r sessionInfo}
Sys.time()
sessionInfo()
```

</details>
