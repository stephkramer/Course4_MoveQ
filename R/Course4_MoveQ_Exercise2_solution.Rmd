---
title: "Tutorial Part IV - Movement - Solution Exercise 2"
author: "Stephanie Kramer-Schadt & CÃ©dric Scherer"
date: "`r Sys.setlocale('LC_TIME','C'); paste('Last Update', format(Sys.time(), '%B %e, %Y'))`"
output:
  rmdformats::readthedown:
    highlight: kate
    toc_depth: 2
    toc_float: true
editor_options:
  chunk_output_type: console
params:
  date: !r Sys.Date()
---

<style>
h1 {
  color: Orange ;
}
h2, h3, h4, h5, h6, legend {
  color: Indigo ;
}
p {
  line-height:170%;
}
#sidebar h2 {
  background-color: Indigo;
}
code {
  color: Indigo ;
}
.exercise {
  color: #824b00;
}
</style>

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      fig.width = 9, fig.height = 6, dev = "ragg_png")
#knitr::opts_knit$set(root.dir = 'C:/Users/kramer/PopDynIZW Dropbox/Steph Kramer')
#or on GUI: knit -> knit directory -> project directory
```

# Exercise 4.2
Three animals have been collared and tracked, and we want to know their home range size and whether the animals actually avoid agriculture and prefer forest. <br>
There is telemetry data available from three animals (DieTiere_32633.shp) in the
folder data-raw. Additionally, land cover (Landnutzung_3035.shp) and rivers (linearegew_32633.shp) are available in the geo-raw folder. 
Land use has a column 'NS1' with coded info on 1 (urban areas), 2 (agriculture), 
3(forest), 4(swamps), 5 (water bodies).<br>

After loading libraries, the data and making a plot, please do the following:<br>
a) Calculate their home ranges.<br>
b) Buffer the home range with the mean displacement per step of all three animals<br>
c) Clip the home ranges with the underlying landscape and calculate the percentage<br>
of land use classes 2/ agriculture and 3/ forest within the home range (hint: use st_intersection)<br>
d) In which land use are the animals actually located? Extract land use underneath
each telemetry location (hint: st_join). Do the animals actually avoid agriculture? <br>



## Get started

```{r}
# Open libraries
## general basics
library(here)
library(ggplot2)

## the basic packages for spatial analyses and viz
library(sf)
library(terra)
library(tmap)

## for telemetry and home range analyses
library(move)
library(adehabitatHR) 
library(sp)
```

### Define workspace and folder structure

```{r}
work_wd <- here()
data_raw_wd <- here('data-raw')
geo_raw_wd  <- here('data-raw/geo-raw')
output_wd   <- here('output')
```

### Load data

```{r}
# if you are not sure about the file names, check the folder content with
# list.files(data_raw_wd)
animals <- st_read(dsn=data_raw_wd,layer="DieTiere_32633")  
landcov <- st_read(layer="Landnutzung_3035", dsn=geo_raw_wd)    
rivers  <- st_read(layer="linearegew_32633", dsn=geo_raw_wd)   
```

### Define or transform CRS

```{r}
lc_32633 <- st_transform(landcov, 32633)
```

### Make a plot of the data

```{r}
#Create a color code for the 5 land use classes
mycol <- c('red','antiquewhite','chartreuse4','cornsilk4','blue')

## TODO - argh, Punkte und Linien erscheinen nicht im html....

plot(lc_32633[,'NS1'], col=mycol[lc_32633$NS1],border='transparent')
plot(animals[,1],col=animals$ID,add=TRUE) 
plot(rivers[,1], col= 'blue', lwd=0.1,add=T)

```

```{r}
#Create a color code for the 5 land use classes
mycol <- c('red','antiquewhite','chartreuse4','cornsilk4','blue')

# TODO - plot mit colorcode mycol funktioniert nicht....

ggplot(lc_32633) + 
  geom_sf(data=lc_32633[,'NS1'], aes(fill  = mycol[NS1]), color='transparent') +
  geom_sf(data=animals) + 
  geom_sf(data=rivers, color='blue') +
  theme_classic()
```

```{r}
#Create a color code for the 5 land use classes
mycol <- c('red','antiquewhite','chartreuse4','cornsilk4','blue')
myid  <- c('yellow','pink','red')

tmap_mode(mode = "view")
tm_shape(shp = lc_32633[,'NS1']) + 
  tm_polygons(col = "NS1", palette = mycol) +
tm_shape(shp = animals[,'ID']) + 
  tm_dots(col = "ID", palette = myid) +
tm_shape(shp = rivers[,1]) + 
  tm_lines(col = 'blue') 
```


## a) & b)
First , we retrieve the steplength. For this, transform the sf-Object into a move-Object.

```{r}
anim_coords <- as.data.frame(st_coordinates(animals)) #returns a list
animals$X <- anim_coords$X
animals$Y <- anim_coords$Y
animals_ng <- st_drop_geometry(animals)

animals_move <- move(x=animals_ng$X, y=animals_ng$Y,
                     time = as.POSIXct(animals_ng$MYDATUM, 
                                       format = "%Y-%m-%d 8:0:0", tz="CET"),
                     proj=CRS("+init=epsg:32633"),
                     data=animals_ng, animal = animals_ng$ID, sensor='GPS')
plot(animals_move, type='l') 

# since we have 3 animals, a list with 3 elements is returned
steplength_per_animal <- distance(animals_move)
mean_stepl_p_anim <- lapply(steplength_per_animal,mean)
(mean(unlist(mean_stepl_p_anim)))
```

The mean step length is approx. 300 m. Now use this value to buffer the MCPs.

```{r}
# for using mcp() in {adehabitatHR}, convert to SpatialPointsDataframe of {sp}
animals_sp <-as(animals, "Spatial")
mcp <- mcp(animals_sp[,'ID'], percent=95) 

# the buffer command needs however an sf object
mcp_sf  <- as(mcp, "sf")
mcp_buf <- st_buffer(mcp_sf, 300)

# the plot is correct
plot(mcp)                         
plot(animals_sp, add=TRUE, col= animals_sp$ID) 
plot(mcp_buf[,1], add=TRUE)
plot(animals_sp, add=TRUE, col= animals_sp$ID) 
plot(mcp, add=TRUE)

# save buffer
st_write(obj = mcp_buf, 
         dsn = output_wd, 
         layer = 'mcp_buffer_32633',
         driver = 'ESRI Shapefile', 
         delete_layer = TRUE)
```

## c) 

```{r}
# check the total area of the buffer in km2 per animal:
buf_area <- st_area(mcp_buf)/1e6

# clip with land use
mcp_buf_lc <- st_intersection(lc_32633, mcp_buf) 
# have a look at the object:
mcp_buf_lc
# take care, you have to recalculate the area!
mcp_buf_lc$areakm2 <- st_area(mcp_buf_lc)/1e6

# now, for each animal id, summarize the area per NS1-category 2 and 3:
agri   <- tapply(mcp_buf_lc$areakm2[mcp_buf_lc$NS1 == 2],
               mcp_buf_lc$id[mcp_buf_lc$NS1 == 2],sum)
forest <- tapply(mcp_buf_lc$areakm2[mcp_buf_lc$NS1 == 3],
                 mcp_buf_lc$id[mcp_buf_lc$NS1 == 3],sum)

# percentages
round((agri/buf_area*100),0)
round((forest/buf_area*100),0)

```

## d)
```{r}
spatjoin <- st_join(animals,lc_32633)
myres <- table(spatjoin$NS1,spatjoin$ID)
myres

# now divide that by the total number of locations per animal
myn <- table(animals$ID)

round((myres[1,]/myn*100),0)  # agriculture
round((myres[2,]/myn*100),0)  # forest

# compare the values with the percentages above
```

For example, animal 1 had 71% of agriculture and 29% of forest in its HR, 
however, only 25% of the locations were actually in agriculture, but 75% of
its locations were in forest. We could conclude that animal 1 avoids agriculture.


# END

---

<details><summary>Session Info</summary>

```{r sessionInfo}
Sys.time()
sessionInfo()
```

</details>
